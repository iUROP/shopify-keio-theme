{% comment %}
  Renders product buy-buttons.
  Accepts:
  - product: {Object} product object.
  - block: {Object} passing the block information.
  - product_form_id: {String} product form id.
  - section_id: {String} id of section to which this snippet belongs.
  - show_pickup_availability: {Boolean} for the pickup availability. If true the pickup availability is rendered, false - not rendered (optional).

  Usage:
  {% render 'buy-buttons', block: block, product: product, product_form_id: product_form_id, section_id: section.id, show_pickup_availability: true %}
{% endcomment %}
<div class="suscription-buy-actions" {{ block.shopify_attributes }}>
  {%- if product != blank -%}
    {%- liquid
      assign gift_card_recipient_feature_active = false
      if block.settings.show_gift_card_recipient and product.gift_card?
        assign gift_card_recipient_feature_active = true
      endif

      assign show_dynamic_checkout = false
      if block.settings.show_dynamic_checkout and gift_card_recipient_feature_active == false
        assign show_dynamic_checkout = true
      endif
    -%}

    <product-form
      class="product-form"
      data-hide-errors="{{ gift_card_recipient_feature_active }}"
      data-section-id="{{ section.id }}"
    >
      <div class="product-form__error-message-wrapper" role="alert" hidden>
        <svg
          aria-hidden="true"
          focusable="false"
          class="icon icon-error"
          viewBox="0 0 13 13"
        >
          <circle cx="6.5" cy="6.50049" r="5.5" stroke="white" stroke-width="2"/>
          <circle cx="6.5" cy="6.5" r="5.5" fill="#EB001B" stroke="#EB001B" stroke-width="0.7"/>
          <path d="M5.87413 3.52832L5.97439 7.57216H7.02713L7.12739 3.52832H5.87413ZM6.50076 9.66091C6.88091 9.66091 7.18169 9.37267 7.18169 9.00504C7.18169 8.63742 6.88091 8.34917 6.50076 8.34917C6.12061 8.34917 5.81982 8.63742 5.81982 9.00504C5.81982 9.37267 6.12061 9.66091 6.50076 9.66091Z" fill="white"/>
          <path d="M5.87413 3.17832H5.51535L5.52424 3.537L5.6245 7.58083L5.63296 7.92216H5.97439H7.02713H7.36856L7.37702 7.58083L7.47728 3.537L7.48617 3.17832H7.12739H5.87413ZM6.50076 10.0109C7.06121 10.0109 7.5317 9.57872 7.5317 9.00504C7.5317 8.43137 7.06121 7.99918 6.50076 7.99918C5.94031 7.99918 5.46982 8.43137 5.46982 9.00504C5.46982 9.57872 5.94031 10.0109 6.50076 10.0109Z" fill="white" stroke="#EB001B" stroke-width="0.7">
        </svg>
        <span class="product-form__error-message"></span>
      </div>

      {%- form 'product',
        product,
        id: product_form_id,
        class: 'form',
        novalidate: 'novalidate',
        data-type: 'add-to-cart-form'
      -%}
        <input
          type="hidden"
          name="id"
          value="{{ product.selected_or_first_available_variant.id }}"
          {% if product.selected_or_first_available_variant.available == false
            or quantity_rule_soldout
            or product.selected_or_first_available_variant == nil
          %}
            disabled
          {% endif %}
          class="product-variant-id"
        >

        <div class="product-form__buttons--variant-picker">
          {% render 'product-variant-picker', product: product, block: block, product_form_id: product_form_id %}

          {% if product.metafields.custom.selector_de_sim %}
            <div class="product-form__buttons--sim-selector">
              <div class="product-form__buttons--sim-selector__heading">
                <span>SIM/eSIM</span>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
                  <mask id="mask0_13558_5736" style="mask-type:alpha" maskUnits="userSpaceOnUse" x="0" y="0" width="24" height="24">
                    <rect width="24" height="24" fill="#D9D9D9"></rect>
                  </mask>
                  <g mask="url(#mask0_13558_5736)">
                    <path d="M11.9998 14.975C11.8665 14.975 11.7415 14.9542 11.6248 14.9125C11.5081 14.8708 11.3998 14.8 11.2998 14.7L6.6998 10.1C6.51647 9.91665 6.4248 9.68332 6.4248 9.39999C6.4248 9.11665 6.51647 8.88332 6.6998 8.69999C6.88314 8.51665 7.11647 8.42499 7.3998 8.42499C7.68314 8.42499 7.91647 8.51665 8.0998 8.69999L11.9998 12.6L15.8998 8.69999C16.0831 8.51665 16.3165 8.42499 16.5998 8.42499C16.8831 8.42499 17.1165 8.51665 17.2998 8.69999C17.4831 8.88332 17.5748 9.11665 17.5748 9.39999C17.5748 9.68332 17.4831 9.91665 17.2998 10.1L12.6998 14.7C12.5998 14.8 12.4915 14.8708 12.3748 14.9125C12.2581 14.9542 12.1331 14.975 11.9998 14.975Z" fill="#5C5E5C"></path>
                  </g>
                </svg>
              </div>
              <div class="product-form__buttons--sim-selector__options">
                <div class="product-form__buttons--sim-selector__options--item">eSIM por email (QR instantáneo)</div>
                <div class="product-form__buttons--sim-selector__options--item">SIM física</div>
              </div>
            </div>
          {% endif %}

          {% assign add_ons = product.metafields.custom.add_ons.value %}
          <div class="custom-product-add-ons">
            {% for add_on in add_ons %}
            <div 
              rel-variant="{% if add_on == 'Bonus Keio Energy' %}55889944969547{% endif %}{% if add_on == 'Protección de línea' %}55889939890507{% endif %}{% if add_on == 'Activación Express' %}55889935270219{% endif %}{% if add_on == 'Multi-SIM' %}55889933173067{% endif %}{% if add_on == 'Servicio Premium de Soporte' %}55901036544331{% endif %}"
              class="custom-product-add-ons--option"
            >
              <div class="custom-product-add-ons--option__inner">
                <div class="custom-add-on">
                  <span></span>
                  <span>{{ add_on }}</span>
                </div>
                <div>
                  {% assign bonus = all_products["bonus-keio-energy"] %}
                  {% assign protection = all_products["proteccion-de-linea"] %}
                  {% assign activation = all_products["activacion-express"] %}
                  {% assign multisim = all_products["multi-sim"] %}
                  {% assign soporte = all_products["servicio-premium-de-soporte"] %}
                  

                  {% if add_on == 'Bonus Keio Energy' %}
                    (-5€)
                  {% endif %}
                  {% if add_on == 'Protección de línea' %}
                    (+{{ protection.price | money }})
                  {% endif %}
                  {% if add_on == 'Activación Express' %}
                    (+{{ activation.price | money }})
                  {% endif %}
                  {% if add_on == 'Multi-SIM' %}
                    (+{{ multisim.price | money }})
                  {% endif %}
                  {% if add_on == 'Servicio Premium de Soporte' %}
                    (+{{ soporte.price | money }})
                  {% endif %}

                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>


        {%- if gift_card_recipient_feature_active -%}
          {%- render 'gift-card-recipient-form', product: product, form: form, section: section -%}
        {%- endif -%}

        <div class="product-form__buttons">

          {%- liquid
            assign check_against_inventory = true
            if product.selected_or_first_available_variant.inventory_management != 'shopify' or product.selected_or_first_available_variant.inventory_policy == 'continue'
              assign check_against_inventory = false
            endif
            if product.selected_or_first_available_variant.quantity_rule.min > product.selected_or_first_available_variant.inventory_quantity and check_against_inventory
              assign quantity_rule_soldout = true
            endif
          -%}
          <div class="product-form__quantity">
            <button>
              <svg xmlns="http://www.w3.org/2000/svg" width="10" height="2" viewBox="0 0 10 2" fill="none">
                <path d="M0 0.0966797H9.90234V1.90332H0V0.0966797Z" fill="#3C1518"/>
              </svg>
            </button>
            <span>1</span>
            <button>
              <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 12 12" fill="none">
                <path d="M0.902344 6.8252V5.18457H5.16016V0.897461H6.83008V5.18457H11.0879V6.8252H6.83008V11.1025H5.16016V6.8252H0.902344Z" fill="#3C1518"/>
              </svg>
            </button>
          </div>
          <button class="product-form__submit_v2">
            Agregar al carrito - <strong class="print-current-price"></strong>
          </button>
          <button
            id="ProductSubmitButton-{{ section_id }}"
            type="submit"
            name="add"
            style="display: none !important;"
            class="product-form__submit is-button-hover-primary button button--full-width {% if show_dynamic_checkout %}button--secondary{% else %}button--primary{% endif %}"
            {% if product.selected_or_first_available_variant.available == false
              or quantity_rule_soldout
              or product.selected_or_first_available_variant == nil
            %}
              disabled
            {% endif %}
          >
            <span>
              {%- if product.selected_or_first_available_variant == nil -%}
                No disponible
              {%- elsif product.selected_or_first_available_variant.available == false or quantity_rule_soldout -%}
                Sin stock
              {%- else -%}
                {{ 'products.product.add_to_cart' | t }}
              {%- endif -%}
            </span>
            {%- render 'loading-spinner' -%}
          </button>
          {%- if show_dynamic_checkout -%}
            {{ form | payment_button }}
          {%- endif -%}
          
          <div class="product-form__buttons--payment-cards">
            <img src="{{ 'complete-payments.png' | asset_url }}" />
          </div>

        </div>
      {%- endform -%}
    </product-form>
  {%- else -%}
    <div class="product-form">
      <div class="product-form__buttons form">
        <button
          type="submit"
          name="add"
          class="product-form__submit button button--full-width button--primary"
          disabled
        >
          {{ 'products.product.sold_out' | t }}
        </button>
      </div>
    </div>
  {%- endif -%}

  {%- if show_pickup_availability -%}
    {{ 'component-pickup-availability.css' | asset_url | stylesheet_tag }}

    {%- assign pick_up_availabilities = product.selected_or_first_available_variant.store_availabilities
      | where: 'pick_up_enabled', true
    -%}

    <pickup-availability
      class="product__pickup-availabilities quick-add-hidden"
      {% if product.selected_or_first_available_variant.available and pick_up_availabilities.size > 0 %}
        available
      {% endif %}
      data-root-url="{{ routes.root_url }}"
      data-variant-id="{{ product.selected_or_first_available_variant.id }}"
      data-has-only-default-variant="{{ product.has_only_default_variant }}"
      data-product-page-color-scheme="gradient color-{{ section.settings.color_scheme }}"
    >
      <template>
        <pickup-availability-preview class="pickup-availability-preview">
          {% render 'icon-unavailable' %}
          <div class="pickup-availability-info">
            <p class="caption-large">{{ 'products.product.pickup_availability.unavailable' | t }}</p>
            <button class="pickup-availability-button link link--text underlined-link">
              {{ 'products.product.pickup_availability.refresh' | t }}
            </button>
          </div>
        </pickup-availability-preview>
      </template>
    </pickup-availability>

    <script src="{{ 'pickup-availability.js' | asset_url }}" defer="defer"></script>
  {%- endif -%}
</div>

<script type="application/json" id="ProductJson-{{ product.id }}">
  {{ product | json }}
</script>